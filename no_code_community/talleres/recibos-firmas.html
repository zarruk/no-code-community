<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taller de Lectura de Recibos y Firmas - No Code Community</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
</head>
<body>
    <header class="hero">
        <nav class="navbar">
            <div class="container">
                <a href="/" class="logo">
                    <img src="../assets/images/logo-new.png" alt="Aztec" class="logo-image">
                </a>
                <a href="/" class="button button-outline">← Volver al inicio</a>
            </div>
        </nav>
        
        <div class="hero-content container">
            <div class="hero-text">
                <span class="workshop-tag">Taller Práctico</span>
                <h1>Taller para lectura de recibos y creación de firmas</h1>
                <p class="hero-subtitle">Sube un recibo y automáticamente extrae la información a Google Sheets mientras genera las firmas digitales necesarias</p>
            </div>
        </div>
    </header>

    <div class="price-banner">
        <div class="container">
            <div class="price-tag">
                <span class="price-cop">COP $99.000</span>
                <span class="price-divider">/</span>
                <span class="price-usd">USD $23.5</span>
            </div>
        </div>
    </div>

    <main>
        <section class="workshop-details">
            <div class="container">
                <div class="video-wrapper">
                    <iframe 
                        width="100%" 
                        height="100%" 
                        src="https://www.youtube.com/embed/oQ2mp9ACWz8" 
                        title="Video explicativo del taller" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                </div>

                <div class="features-grid">
                    <div class="feature-card">
                        <img src="https://cdn-icons-png.flaticon.com/512/4616/4616089.png" alt="OCR">
                        <h3>OCR</h3>
                        <p>Extrae texto automáticamente de imágenes y documentos escaneados</p>
                    </div>
                    <div class="feature-card">
                        <img src="https://cdn-icons-png.flaticon.com/512/1828/1828640.png" alt="Firmas">
                        <h3>Firmas Digitales</h3>
                        <p>Genera y gestiona firmas digitales de forma automatizada</p>
                    </div>
                    <div class="feature-card">
                        <img src="https://cdn-icons-png.flaticon.com/512/1935/1935765.png" alt="n8n">
                        <h3>n8n</h3>
                        <p>Crea flujos de trabajo potentes sin escribir código</p>
                    </div>
                    <div class="feature-card">
                        <img src="https://cdn-icons-png.flaticon.com/512/2991/2991148.png" alt="Gemini" style="width: 32px; height: 32px;">
                        <h3>Gemini 2.0 Flash</h3>
                        <p>Procesa y clasifica información automáticamente con la IA más avanzada de Google</p>
                    </div>
                </div>

                <style>
                .features-grid {
                    display: flex;
                    justify-content: center;
                    gap: var(--spacing-4);
                    overflow-x: auto;
                    padding: var(--spacing-4) 0;
                    width: 100%;
                    align-items: stretch;
                    flex-wrap: wrap;
                    max-width: 900px;
                    margin: 0 auto;
                }

                .feature-card {
                    flex: 0 0 200px;
                    min-width: 200px;
                }

                .feature-card img {
                    width: 32px;
                    height: 32px;
                    object-fit: contain;
                }
                </style>
            </div>
        </section>

        <section class="registration">
            <div class="container">
                <div class="section-header">
                    <h2>¡Inscríbete ahora!</h2>
                    <p>Cupos limitados para una mejor experiencia de aprendizaje</p>
                </div>

                <div class="sessions-grid">
                    <!-- Las sesiones se cargarán dinámicamente aquí -->
                </div>

                <div class="waitlist-container" style="text-align: center; margin-top: var(--spacing-8);">
                    <button class="waitlist-button" onclick="showWaitlistForm()">
                        Unirme a lista de espera
                    </button>
                </div>

                <div class="waitlist-form" id="waitlist-form">
                    <h3>Lista de espera - Taller de Recibos y Firmas</h3>
                    <div class="form-group">
                        <label for="waitlist-name">Nombre completo</label>
                        <input type="text" id="waitlist-name" required>
                    </div>
                    <div class="form-group">
                        <label for="waitlist-email">Correo electrónico</label>
                        <input type="email" id="waitlist-email" required>
                    </div>
                    <div class="form-group">
                        <label for="waitlist-phone">Teléfono</label>
                        <input type="tel" id="waitlist-phone" required>
                    </div>
                    <button class="button button-primary" onclick="submitWaitlist()">
                        Registrarme en lista de espera
                    </button>
                    <div class="waitlist-success" id="waitlist-success">
                        ¡Te has registrado exitosamente en la lista de espera!
                    </div>
                </div>

                <div class="user-data-form">
                    <div class="form-group">
                        <label for="fullName">Nombre completo</label>
                        <input type="text" id="fullName" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Correo electrónico</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Teléfono</label>
                        <input type="tel" id="phone" required>
                    </div>
                    <button class="button button-primary" onclick="submitRegistration()">
                        Registrarme al taller
                    </button>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 No Code Community. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script>
    let selectedDate = '';
    let userData = {
        fullName: '',
        email: '',
        phone: ''
    };
    let phoneInput;
    let registrationPhoneInput;

    async function loadSessions() {
        try {
            const SHEET_ID = '15R-TE_3mhfHmvk-tUr1fdZOAQrhm4zFIPooqQA3YLTg';
            const SHEET_GID = '69198986'; // Este es el gid del Sheet4
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;
            
            const response = await fetch(url);
            const text = await response.text();
            const rows = text.split('\n').slice(1); // Ignorar la primera fila (headers)
            
            const sessionsGrid = document.querySelector('.sessions-grid');
            sessionsGrid.innerHTML = ''; // Limpiar sesiones existentes
            
            rows.forEach((row, index) => {
                if (!row.trim()) return; // Ignorar filas vacías
                
                const [fecha, cuposRestantes, cupoTotal] = row.split(',');
                const cupos = Math.max(0, parseInt(cuposRestantes)); // Si es negativo, mostrar 0
                const dia = getDayOfWeek(fecha.trim());
                
                const sessionHTML = `
                    <div class="session-card ${cupos === 0 ? 'disabled' : ''}">
                        <input type="radio" name="session" value="${fecha.trim()}" 
                               id="session${index + 1}" ${cupos === 0 ? 'disabled' : ''}>
                        <label for="session${index + 1}">
                            <div class="session-date">
                                <span class="day">${dia}</span>
                                <span class="date">${fecha.trim()}</span>
                                <span class="time">6:00 PM</span>
                            </div>
                            <div class="session-spots">
                                <span class="spots-available">
                                    ${cupos === 0 ? 'No hay cupos disponibles' : `${cupos} cupos disponibles`}
                                </span>
                            </div>
                        </label>
                    </div>
                `;
                sessionsGrid.innerHTML += sessionHTML;
            });
            
            initializeSessionListeners();
        } catch (error) {
            console.error('Error cargando las sesiones:', error);
        }
    }

    function getDayOfWeek(dateStr) {
        const [dia, mes] = dateStr.split(' de ');
        const year = new Date().getFullYear();
        const date = new Date(`${mes} ${dia}, ${year}`);
        const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
        return days[date.getDay()];
    }

    function initializeSessionListeners() {
        document.querySelectorAll('.session-card input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                document.querySelectorAll('.session-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                if (!e.target.disabled) {
                    e.target.closest('.session-card').classList.add('selected');
                    selectedDate = e.target.value;
                    document.querySelector('.user-data-form').style.display = 'block';
                    
                    // Limpiar campos y objeto userData al seleccionar nueva sesión
                    document.getElementById('fullName').value = '';
                    document.getElementById('email').value = '';
                    registrationPhoneInput.setNumber('');
                    userData = {
                        fullName: '',
                        email: '',
                        phone: ''
                    };
                }
            });
        });
    }

    function showWaitlistForm() {
        document.getElementById('waitlist-form').style.display = 'block';
    }

    async function submitWaitlist() {
        const nameInput = document.getElementById('waitlist-name');
        const emailInput = document.getElementById('waitlist-email');
        const name = nameInput.value.trim();
        const email = emailInput.value.trim();
        const phone = phoneInput.getNumber();
        
        if (!name || !email || !phoneInput.isValidNumber()) {
            alert('Por favor completa todos los campos correctamente');
            return;
        }
        
        // Validación básica de email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert('Por favor ingresa un correo electrónico válido');
            return;
        }
        
        try {
            const response = await fetch('https://workflows.ops.sandbox.cuentamono.com/webhook/a466287a-5bad-45a2-a2fa-dd768a6319bf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    email: email,
                    phone: phone,
                    registrationDate: new Date().toISOString(),
                    source: 'waitlist-recibos'
                })
            });

            if (!response.ok) {
                throw new Error('Error en el envío');
            }

            const successMessage = document.getElementById('waitlist-success');
            successMessage.style.display = 'block';
            
            // Limpiar campos
            nameInput.value = '';
            emailInput.value = '';
            phoneInput.setNumber('');
            
            // Ocultar el formulario después de un tiempo
            setTimeout(() => {
                document.getElementById('waitlist-form').style.display = 'none';
                successMessage.style.display = 'none';
            }, 3000);
            
        } catch (error) {
            console.error('Error al registrar en lista de espera:', error);
            alert('Hubo un error al registrarte en la lista de espera. Por favor intenta nuevamente.');
        }
    }

    // Mover los event listeners dentro del DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
        // Inicializar teléfonos
        const waitlistPhoneField = document.querySelector("#waitlist-phone");
        phoneInput = window.intlTelInput(waitlistPhoneField, {
            preferredCountries: ["co"],
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
        });

        const registrationPhoneField = document.querySelector("#phone");
        registrationPhoneInput = window.intlTelInput(registrationPhoneField, {
            preferredCountries: ["co"],
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
        });

        // Agregar event listeners para los inputs
        document.querySelectorAll('.user-data-form input').forEach(input => {
            input.addEventListener('input', (e) => {
                userData[e.target.id] = e.target.value.trim();
                console.log('userData actualizado:', userData); // Para debugging
            });
        });

        loadSessions();
    });

    async function submitRegistration() {
        try {
            console.log('Iniciando registro con datos:', { 
                userData, 
                selectedDate, 
                phone: registrationPhoneInput?.getNumber() 
            });

            // Verificar que registrationPhoneInput esté inicializado
            if (!registrationPhoneInput) {
                throw new Error('Error: El campo de teléfono no está inicializado correctamente');
            }

            // Validar que todos los campos estén llenos
            if (!userData.fullName || !userData.email || !registrationPhoneInput.isValidNumber()) {
                alert('Por favor completa todos los campos correctamente');
                return;
            }
            
            // Validar email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(userData.email)) {
                alert('Por favor ingresa un correo electrónico válido');
                return;
            }

            // Validar que se haya seleccionado una fecha
            if (!selectedDate) {
                alert('Por favor selecciona una sesión');
                return;
            }

            const dataToSend = {
                name: userData.fullName,
                email: userData.email,
                phone: registrationPhoneInput.getNumber(),
                registrationDate: new Date().toISOString(),
                selectedSession: selectedDate,
                source: 'registration-recibos'
            };

            console.log('Enviando datos:', dataToSend);

            const response = await fetch('https://workflows.ops.sandbox.cuentamono.com/webhook/a466287a-5bad-45a2-a2fa-dd768a6319bf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dataToSend)
            });

            const responseData = await response.json();
            console.log('Respuesta del servidor:', responseData);

            if (!response.ok) {
                throw new Error(`Error en el envío: ${response.status} ${response.statusText}`);
            }

            alert('¡Registro exitoso! Te contactaremos pronto con los detalles del pago.');
            
            // Limpiar campos y objeto userData
            document.getElementById('fullName').value = '';
            document.getElementById('email').value = '';
            registrationPhoneInput.setNumber('');
            userData = {
                fullName: '',
                email: '',
                phone: ''
            };
            
            // Ocultar formularios
            document.querySelector('.user-data-form').style.display = 'none';
            
        } catch (error) {
            console.error('Error detallado al registrarse:', error);
            alert('Hubo un error al procesar tu registro. Por favor intenta nuevamente.');
        }
    }
    </script>
</body>
</html> 