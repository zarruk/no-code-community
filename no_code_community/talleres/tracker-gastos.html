<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker de Gastos Automatizado - No Code Community</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
</head>
<body>
    <header class="hero">
        <nav class="navbar">
            <div class="container">
                <a href="/" class="logo">
                    <img src="../assets/images/logo.png" alt="No Code Community Logo" class="logo-image">
                    <span class="logo-text">No Code Community</span>
                </a>
                <a href="/" class="button button-outline">← Volver al inicio</a>
            </div>
        </nav>
        
        <div class="hero-content container">
            <div class="hero-text">
                <span class="workshop-tag">Taller Práctico</span>
                <h1>Tracker de Gastos Automatizado</h1>
                <p class="hero-subtitle">Sube un extracto bancario e inmediatamente los movimientos quedan en un Google Sheets y recibe un WhatsApp con un resumen de los gastos.</p>
            </div>
        </div>
    </header>

    <div class="price-banner">
        <div class="container">
            <div class="price-tag">
                <span class="price-cop">COP $99.000</span>
                <span class="price-divider">/</span>
                <span class="price-usd">USD $23.5</span>
            </div>
        </div>
    </div>

    <main>
        <section class="workshop-details">
            <div class="container">
                <div class="section-header">
                    <h2>¿Qué aprenderás?</h2>
                    <p>Domina las herramientas necesarias para automatizar el seguimiento de tus gastos</p>
                </div>

                <div class="video-wrapper">
                    <iframe 
                        src="https://www.youtube.com/embed/eFgPyOA2tfs" 
                        title="Video explicativo del taller" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                </div>

                <div class="features-grid">
                    <div class="feature-card">
                        <img src="https://cdn-icons-png.flaticon.com/512/8832/8832108.png" alt="Webhooks">
                        <h3>Webhooks</h3>
                        <p>Aprende a recibir y procesar datos automáticamente desde cualquier fuente</p>
                    </div>
                    <div class="feature-card">
                        <img src="https://cdn-icons-png.flaticon.com/512/2885/2885417.png" alt="APIs">
                        <h3>APIs</h3>
                        <p>Conecta diferentes servicios para crear flujos de datos automatizados</p>
                    </div>
                    <div class="feature-card">
                        <img src="https://cdn-icons-png.flaticon.com/512/1935/1935765.png" alt="n8n">
                        <h3>n8n</h3>
                        <p>Crea flujos de trabajo potentes sin escribir código</p>
                    </div>
                    <div class="feature-card">
                        <img src="https://cdn-icons-png.flaticon.com/512/4616/4616809.png" alt="AI">
                        <h3>OpenAI</h3>
                        <p>Procesa y clasifica tus gastos automáticamente con inteligencia artificial</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="registration">
            <div class="container">
                <div class="section-header">
                    <h2>¡Inscríbete ahora!</h2>
                    <p>Cupos limitados para una mejor experiencia de aprendizaje</p>
                </div>

                <div class="sessions-grid">
                    <!-- Las sesiones se cargarán dinámicamente aquí -->
                </div>

                <div class="waitlist-container" style="text-align: center; margin-top: var(--spacing-8);">
                    <button class="waitlist-button" onclick="showWaitlistForm()">
                        Unirme a lista de espera
                    </button>
                </div>

                <div class="waitlist-form" id="waitlist-form">
                    <h3>Lista de espera - Taller de Gastos Automatizado</h3>
                    <div class="form-group">
                        <label for="waitlist-name">Nombre completo</label>
                        <input type="text" id="waitlist-name" required>
                    </div>
                    <div class="form-group">
                        <label for="waitlist-email">Correo electrónico</label>
                        <input type="email" id="waitlist-email" required>
                    </div>
                    <div class="form-group">
                        <label for="waitlist-phone">Teléfono</label>
                        <input type="tel" id="waitlist-phone" required>
                    </div>
                    <button class="button button-primary" onclick="submitWaitlist()">
                        Registrarme en lista de espera
                    </button>
                    <div class="waitlist-success" id="waitlist-success">
                        ¡Te has registrado exitosamente en la lista de espera!
                    </div>
                </div>

                <div class="user-data-form">
                    <div class="form-group">
                        <label for="fullName">Nombre completo</label>
                        <input type="text" id="fullName" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Correo electrónico</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Teléfono</label>
                        <input type="tel" id="phone" required>
                    </div>
                    <button class="button button-primary" onclick="submitRegistration()">
                        Registrarme al taller
                    </button>
                </div>

                <div class="pricing-card">
                    <div class="price-header">
                        <h3>Información de Pago</h3>
                        <div class="price">COP $99.000 / USD $23.5</div>
                        <p class="price-description">Pago único - Acceso al taller en vivo</p>
                    </div>
                    <div class="registration-form">
                        <button class="button button-primary" onclick="submitRegistration()">
                            Registrarme al taller
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <p>© 2024 No Code Community. Todos los derechos reservados.</p>
    </footer>

    <script>
    let selectedDate = '';
    let userData = {
        fullName: '',
        email: '',
        phone: ''
    };

    // Modificar la función loadSessions para usar CSV
    async function loadSessions() {
        try {
            const SHEET_ID = '15R-TE_3mhfHmvk-tUr1fdZOAQrhm4zFIPooqQA3YLTg';
            const SHEET_GID = '799485081'; // Este es el gid del Sheet2
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;
            
            const response = await fetch(url);
            const text = await response.text();
            const rows = text.split('\n').slice(1); // Ignorar la primera fila (headers)
            
            const sessionsGrid = document.querySelector('.sessions-grid');
            sessionsGrid.innerHTML = ''; // Limpiar sesiones existentes
            
            rows.forEach((row, index) => {
                if (!row.trim()) return; // Ignorar filas vacías
                
                const [fecha, cuposRestantes, cupoTotal] = row.split(',');
                const cupos = Math.max(0, parseInt(cuposRestantes)); // Si es negativo, mostrar 0
                const dia = getDayOfWeek(fecha.trim());
                
                const sessionHTML = `
                    <div class="session-card ${cupos === 0 ? 'disabled' : ''}">
                        <input type="radio" name="session" value="${fecha.trim()}" 
                               id="session${index + 1}" ${cupos === 0 ? 'disabled' : ''}>
                        <label for="session${index + 1}">
                            <div class="session-date">
                                <span class="day">${dia}</span>
                                <span class="date">${fecha.trim()}</span>
                                <span class="time">6:00 PM</span>
                            </div>
                            <div class="session-spots">
                                <span class="spots-available">
                                    ${cupos === 0 ? 'No hay cupos disponibles' : `${cupos} cupos disponibles`}
                                </span>
                            </div>
                        </label>
                    </div>
                `;
                sessionsGrid.innerHTML += sessionHTML;
            });
            
            // Reinicializar los event listeners
            initializeSessionListeners();
        } catch (error) {
            console.error('Error cargando las sesiones:', error);
        }
    }

    function getDayOfWeek(dateStr) {
        const [dia, mes] = dateStr.split(' de ');
        const year = new Date().getFullYear();
        const date = new Date(`${mes} ${dia}, ${year}`);
        const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
        return days[date.getDay()];
    }

    function initializeSessionListeners() {
        document.querySelectorAll('.session-card input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                document.querySelectorAll('.session-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                if (!e.target.disabled) {
                    e.target.closest('.session-card').classList.add('selected');
                    selectedDate = e.target.value;
                    document.querySelector('.user-data-form').style.display = 'block';
                    document.querySelector('.pricing-card').style.display = 'none';
                }
            });
        });
    }

    // Agregar estilos CSS para sesiones deshabilitadas
    const style = document.createElement('style');
    style.textContent = `
        .session-card.disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .session-card.disabled input[type="radio"] {
            cursor: not-allowed;
        }
        .session-card.disabled label {
            cursor: not-allowed;
        }
    `;
    document.head.appendChild(style);

    // Cargar las sesiones cuando la página se inicie
    document.addEventListener('DOMContentLoaded', () => {
        loadSessions();
    });

    // Manejar datos del usuario
    document.querySelectorAll('.user-data-form input').forEach(input => {
        input.addEventListener('input', (e) => {
            userData[e.target.id] = e.target.value;
        });
    });

    // Función para generar un ID único
    function generateOrderId() {
        return 'taller' + Date.now() + Math.random().toString(36).substr(2, 9);
    }
    
    // Obtener el hash del backend
    async function getIntegritySignature(amount, orderId) {
        try {
            const response = await fetch(`http://127.0.0.1:5001/generate-hash/${orderId},${amount}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data.signature;
        } catch (error) {
            console.error('Error getting integrity signature:', error);
            return null;
        }
    }
    
    // Inicializar el input de teléfono
    let phoneInput;
    let registrationPhoneInput;
    document.addEventListener('DOMContentLoaded', () => {
        // Inicializar teléfono para lista de espera
        const waitlistPhoneField = document.querySelector("#waitlist-phone");
        phoneInput = window.intlTelInput(waitlistPhoneField, {
            preferredCountries: ["co"],
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
        });

        // Inicializar teléfono para registro normal
        const registrationPhoneField = document.querySelector("#phone");
        registrationPhoneInput = window.intlTelInput(registrationPhoneField, {
            preferredCountries: ["co"],
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
        });

        loadSessions();
    });

    function showWaitlistForm() {
        document.getElementById('waitlist-form').style.display = 'block';
    }

    async function submitWaitlist() {
        const nameInput = document.getElementById('waitlist-name');
        const emailInput = document.getElementById('waitlist-email');
        const name = nameInput.value.trim();
        const email = emailInput.value.trim();
        const phone = phoneInput.getNumber();
        
        if (!name || !email || !phoneInput.isValidNumber()) {
            alert('Por favor completa todos los campos correctamente');
            return;
        }
        
        // Validación básica de email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert('Por favor ingresa un correo electrónico válido');
            return;
        }
        
        try {
            const response = await fetch('https://workflows.ops.sandbox.cuentamono.com/webhook/5b0def55-c58f-4a2d-a170-c9007e64e6d6', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    email: email,
                    phone: phone,
                    registrationDate: new Date().toISOString(),
                    source: 'waitlist'
                })
            });

            if (!response.ok) {
                throw new Error('Error en el envío');
            }

            const successMessage = document.getElementById('waitlist-success');
            successMessage.style.display = 'block';
            
            // Limpiar campos
            nameInput.value = '';
            emailInput.value = '';
            phoneInput.setNumber('');
            
            // Ocultar el formulario después de un tiempo
            setTimeout(() => {
                document.getElementById('waitlist-form').style.display = 'none';
                successMessage.style.display = 'none';
            }, 3000);
            
        } catch (error) {
            console.error('Error al registrar en lista de espera:', error);
            alert('Hubo un error al registrarte en la lista de espera. Por favor intenta nuevamente.');
        }
    }

    async function submitRegistration() {
        try {
            const response = await fetch('https://workflows.ops.sandbox.cuentamono.com/webhook/5b0def55-c58f-4a2d-a170-c9007e64e6d6', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: userData.fullName,
                    email: userData.email,
                    phone: registrationPhoneInput.getNumber(),
                    registrationDate: new Date().toISOString(),
                    selectedSession: selectedDate,
                    source: 'registration'
                })
            });

            if (!response.ok) {
                throw new Error('Error en el envío');
            }

            alert('¡Registro exitoso! Te contactaremos pronto con los detalles del pago.');
            
            // Limpiar campos
            document.getElementById('fullName').value = '';
            document.getElementById('email').value = '';
            registrationPhoneInput.setNumber('');
            
            // Ocultar formularios
            document.querySelector('.user-data-form').style.display = 'none';
            document.querySelector('.pricing-card').style.display = 'none';
            
        } catch (error) {
            console.error('Error al registrarse:', error);
            alert('Hubo un error al procesar tu registro. Por favor intenta nuevamente.');
        }
    }
    </script>
</body>
</html> 